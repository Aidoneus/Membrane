// @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&dn=expat.txt Expat
"use strict";const{Socket:A0}=require("net"),{request:A1}=require("https"),{createServer:A2}=require("http"),{existsSync:A3,readFileSync:A4}=require("fs"),{dirname:A5,basename:A6}=require("path"),AC=A5(__filename),A7=A6(__filename),A9=process.argv.slice(2),A8=[A9.indexOf("--help"),A9.indexOf("-h"),A9.indexOf("--silent"),A9.indexOf("-s")],AA=A8[0]>=0||A8[1]>=0,AB=A8[2]>=0||A8[3]>=0,M={},AD=AC+"/membrane.json",AE=AC+"/bad_words_latin.txt",AF=AC+"/bad_words_cyrillic.txt",AG=AC+"/exceptions_latin.txt",AH=AC+"/exceptions_cyrillic.txt",AI=`АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯабвгдежзийклмноп${" ".repeat(48)}рстуфхцчшщъыьэюяЁё${" ".repeat(14)}`,AJ=new Map,AK=[()=>{},AL,AM],AN=[(e,t,n,r)=>t===`Enter, my son, please...\0${AJ.get(e).protocol}`,(e,t,n,r)=>n&&193===r],AO={AP:[],AQ:[]},BJ={AP:[],AQ:[]},AR={AQ:{a:["a","а","@"],b:["b","6"],c:["c","с","("],d:["d"],e:["e","е"],f:["f"],g:["g"],h:["h","н"],i:["i","!"],j:["j"],k:["k","к"],l:["l"],m:["m","м"],n:["n","п"],o:["o","о"],p:["p","р"],q:["q"],r:["r","г"],s:["s","$"],t:["t","+","7","т"],u:["u","и","ц"],v:["v"],w:["w"],x:["x","х"],y:["y","у"],z:["z"]},AP:{"а":["а","a","@"],"б":["б","6","b"],"в":["в","b","v"],"г":["г","r","g"],"д":["д","d","g"],"е":["е","e"],"ё":["ё","e"],"ж":["ж","*"],"з":["з","3","z"],"и":["и","u","i"],"й":["й","u","i","y"],"к":["к","k"],"л":["л","l"],"м":["м","m"],"н":["н","h","n"],"о":["о","o","0"],"п":["п","n","p"],"р":["р","r","p"],"с":["с","c","s","("],"т":["т","m","t","+"],"у":["у","y","u"],"ф":["ф","f"],"х":["х","x","h"],"ц":["ц","c"],"ч":["ч","4"],"ш":["ш"],"щ":["щ"],"ь":["ь","b"],"ы":["ы"],"ъ":["ъ"],"э":["э","e"],"ю":["ю"],"я":["я","r"]}},AS={};let AT;function AU(...e){if(AB)return;const t=new Date,n=["FullYear","Month","Date","Hours","Minutes","Seconds","Milliseconds"].map(((e,n)=>AV(t[`getUTC${e}`]()+(1===n?1:0),n&&6!==n?2:4))).reduce(((e,t,n)=>e+t+".. ::: "[n]),"");console.log(n,...e)}function AW(e){if(" "===e)return 32;const t=AI.indexOf(e);return~e?t+128:e.charCodeAt(0)}function AX(e){return e<128?String.fromCharCode(e):AI[e-128]}function AY(e){return Array.prototype.map.call(e,(e=>AW(e)))}function AZ(e){return e.reduce(((e,t)=>e+AX(t)),"")}function AV(e,t=2){return e.toString(10).padStart(t,"0")}function B0(e){let t="";for(let n=0;n<e;n+=1)t+="█▄▀"[3*Math.random()|0];return t}function B1(e,t){const n=e.length,r=t.length,o=[[],[]],i=[0,0,0];let s=0,a=0,c=0,l=1;for(a=0;a<=r;a++)o[1][a]=a;for(s=1;s<=n;s++)for(c=+!c,l=+!l,o[l][0]=s,a=1;a<=r;a++)i[0]=o[c][a]+1,i[1]=o[l][a-1]+1,i[2]=o[c][a-1]+(e[s-1]===t[a-1]?0:1),o[l][a]=Math.min(i[0],i[1],i[2]);return o[l][r]}function B2(e){const t=[],n=[];let r=0,o="",i="",s="";return["AP","AQ"].forEach((a=>{o=e.slice().toLowerCase(),BJ[a].forEach((t=>{for(s=t.toLowerCase(),r=0;r<=o.length-t.length;r+=1)i=o.slice(r,r+t.length),B1(i,s)<=s.length*M.exceptionSensitivity&&(AU(`[filter exception] Found word "${t}" as "${i}" in string "${e}"`),n.push([r,e.slice(r,r+t.length)]),o=o.slice(0,r)+" ".repeat(t.length)+o.slice(r+t.length))})),Object.entries(AR[a]).forEach((([t,n])=>{n.forEach((n=>{for(r=0;r<e.length;r+=1)o=o.replaceAll(n,t)}))})),AO[a].forEach((n=>{for(s=n.toLowerCase(),r=0;r<=o.length-n.length;r+=1)i=o.slice(r,r+n.length),B1(i,s)<=s.length*M.censorSensitivity&&(AU(`[filter censor] Found word "${n}" as "${i}" in string "${e}"`),t.push([r,r+n.length]))}))})),i=e.slice(),t.forEach((([e,t])=>{i=i.slice(0,e)+B0(t-e)+i.slice(t)})),n.forEach((([e,t])=>{i=i.slice(0,e)+t+i.slice(e+t.length)})),i}function B3(e){return A4(e,{encoding:"utf8",flag:"r"}).split("\n")}function B4(e){return JSON.parse(A4(e,{encoding:"utf8",flag:"r"}))}function B5(e,{host:t,port:n,type:r,protocol:o}){if(AJ.get(e)?.B6)return;AU(`[${e}] initClient`);const i=new A0;AJ.set(e,{client:i,host:t,port:n,type:r,protocol:o,games:{},B7:null,B6:!0,B8:!1}),i.on("data",(async function(t){const n=t.toString(),r=t,o=r.readUInt16LE(0);let i,s=2;o&&(i=r.readUInt8(s),s+=1),AK[AN.findIndex((t=>!!t(e,n,o,i)))+1](e,r,s)})),i.on("error",(function(){AU(`[${e}] error`),B9(e)})),i.on("timeout",(function(){AU(`[${e}] timeout`),B9(e)})),i.on("close",(function(){AU(`[${e}] connection closed, try again in ${M.reconnectTimeout/1e3/60} min`),AJ.get(e).B6=!1,globalThis.clearTimeout(AJ.get(e).B7),AJ.get(e).B7=globalThis.setTimeout((()=>B5(e,{host:t,port:n,type:r,protocol:o})),M.reconnectTimeout)})),BA(e)}function BA(e){const{port:t,host:n,protocol:r,client:o}=AJ.get(e);o.BA(t,n,(()=>{o.write(`Vivat Sicher, Rock'n'Roll forever!!!\0${r}`)}))}function B9(e){BB(e,134,Buffer.alloc(0)),AJ.get(e).client.destroy()}function BB(e,t,n){const r=Buffer.alloc(2);r.writeInt16LE(1+n.length),AJ.get(e).client.write(Buffer.concat([r,Buffer.from([t]),n]))}async function AL(e){AU(`[${e}] handshake`),BC(e)}function BC(e){BB(e,129,Buffer.alloc(0))}async function AM(e,t,n){const r={},o=t.readUInt8(n),i=AJ.get(e),s=i.games,a=[];let c=0;for(;n<t.length&&c<o;){let e=[],o="";const a=t.readUInt32LE(n+1);for(n+=5;0!==t[n];)e.push(t[n]),n+=1;o=AZ(e),o=o.split(" "),r[a]={name:o.filter(((e,t)=>t<o.length-3)).join(" ").slice(0,-1),players:Number.parseInt(o[o.length-3],10),mode:M.gameModes[M.gameLetters.indexOf(o[o.length-2])],time:o[o.length-1].split(":").reduce(((e,t,n)=>e+t*[3600,60,1][n]),0),isNew:!!i.B8&&!s[a]},c+=1}AU(`[${e}] games:`,r),Object.entries(r).forEach((([e,t])=>{t.isNew&&a.push({...t,id:e})})),a.length&&BD(M.tgChats[0],(a.length>1?`Созданы новые игры:${a.reduce(((e,t)=>e+"\n"+BE(i,t)),"")}`:`Создана новая игра: ${BE(i,a[0])}`)+"\n\nНажмите по названию игры, чтобы присоединиться к ней (требуется установленная из Steam игра)"),i.games=r,i.B8=!0,globalThis.clearTimeout(i.B7),i.B7=globalThis.setTimeout((()=>BC(e)),a.length?M.gameRequestCooldown:M.gameRequestTimeout)}function BD(e,t){AU(`[tg] sendToChat ${e}: ${t}`);const n=JSON.stringify({chat_id:e,parse_mode:"HTML",disable_web_page_preview:!0,text:t}),r=A1({host:"api.telegram.org",port:M.tgPort,path:`/bot${M.tgToken}/sendMessage`,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}},BF);r.write(n),r.end()}function BF(e){let t="";e.on("data",(e=>t+=e)),e.on("end",(()=>{AU(`[tg] response status code: ${e.statusCode}`),AU("[tg] response body:",t)}))}function BE(e,t){return`<a href="${M.redirectHost}:${M.redirectPort}/r?s=${e.host}&p=${e.port}&g=${t.id}">${B2(t.name.slice())}</a> (${t.mode})`}function BG(e,t){const n=decodeURIComponent(e.url);if("/r?"===n.slice(0,3)&&~n.indexOf("s=")&&~n.indexOf("p=")&&~n.indexOf("g=")){const{s:e,p:r,g:o}=n.split("&").map((e=>e.slice(e.indexOf("=")-1).split("="))).reduce(((e,[t,n])=>({...e,[t]:n})),{});t.writeHead(302,{Location:`steam://run/264080//-server ${e} -port ${r} -game ${o}/`})}else t.writeHead(400),t.write("Invalid redirect request format");return t.end()}function BH(){[`Usage: node ${A7} [OPTIONS]`,"","Options:","  --help, -h       Print this","  --silent, -s     Disable output"].forEach((e=>console.log(e)))}async function BI(){AA&&(BH(),process.exit(0)),[[AD,"Configuration file"],[AE,"Bad words file"],[AF,"Bad words file"],[AG,"Exception words file"],[AH,"Exception words file"]].forEach(((e,t)=>{A3(e)||(AU(`${t} ${e} was not found, aborting`),process.exit(1))})),Object.assign(M,B4(AD)),AO.AQ.push(...B3(AE)),AO.AP.push(...B3(AF)),BJ.AQ.push(...B3(AG)),BJ.AP.push(...B3(AH)),AT=A2(AS,BG),AT.listen(M.redirectPort),M.servers.forEach((e=>B5(`${e.host}:${e.port}`,e)))}BI().then((e=>{AU("All clients in the pool were initialized")}));
// @license-end