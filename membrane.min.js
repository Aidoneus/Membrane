// @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&dn=expat.txt Expat
"use strict";const{Socket:Socket}=require("net"),{request:request}=require("https"),{createServer:createServer}=require("http"),{existsSync:existsSync,readFileSync:readFileSync}=require("fs"),{dirname:dirname,basename:basename}=require("path"),dir=dirname(__filename),scriptFile=basename(__filename),args=process.argv.slice(2),argsI=[args.indexOf("--help"),args.indexOf("-h"),args.indexOf("--silent"),args.indexOf("-s")],argHelp=argsI[0]>=0||argsI[1]>=0,argSilent=argsI[2]>=0||argsI[3]>=0,M={},configPath=dir+"/membrane.json",badWordsLatinPath=dir+"/bad_words_latin.txt",badWordsCyrillicPath=dir+"/bad_words_cyrillic.txt",cp866=`АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯабвгдежзийклмноп${" ".repeat(48)}рстуфхцчшщъыьэюяЁё${" ".repeat(14)}`,clientPool=new Map,reactions=[()=>{},handshake,receiveGames],conditions=[(e,t,n,o)=>t===`Enter, my son, please...\0${clientPool.get(e).protocol}`,(e,t,n,o)=>n&&193===o],badWords={cyr:[],lat:[]},censorCharmap={lat:{a:["a","а","@"],b:["b","6"],c:["c","с","("],d:["d"],e:["e","е"],f:["f"],g:["g"],h:["h","н"],i:["i","!"],j:["j"],k:["k","к"],l:["l"],m:["m","м"],n:["n","п"],o:["o","о"],p:["p","р"],q:["q"],r:["r","г"],s:["s","$"],t:["t","+","7","т"],u:["u","и","ц"],v:["v"],w:["w"],x:["x","х"],y:["y","у"],z:["z"]},cyr:{"а":["а","a","@"],"б":["б","6","b"],"в":["в","b","v"],"г":["г","r","g"],"д":["д","d","g"],"е":["е","e"],"ё":["ё","e"],"ж":["ж","*"],"з":["з","3","z"],"и":["и","u","i"],"й":["й","u","i","y"],"к":["к","k"],"л":["л","l"],"м":["м","m"],"н":["н","h","n"],"о":["о","o","0"],"п":["п","n","p"],"р":["р","r","p"],"с":["с","c","s","("],"т":["т","m","t","+"],"у":["у","y","u"],"ф":["ф","f"],"х":["х","x","h"],"ц":["ц","c"],"ч":["ч","4"],"ш":["ш"],"щ":["щ"],"ь":["ь","b"],"ы":["ы"],"ъ":["ъ"],"э":["э","e"],"ю":["ю"],"я":["я","r"]}},tgStack=[],redirectServerOptions={};let webServer;function log(...e){!argSilent&&console.log(...e)}function encodeChar(e){if(" "===e)return 32;const t=cp866.indexOf(e);return~e?t+128:e.charCodeAt(0)}function decodeChar(e){return e<128?String.fromCharCode(e):cp866[e-128]}function encodeString(e){return Array.prototype.map.call(e,(e=>encodeChar(e)))}function decodeArray(e){return e.reduce(((e,t)=>e+decodeChar(t)),"")}function pad(e,t=2){return e.toString(10).padStart(t,"0")}function getRndString(e){let t="";for(let n=0;n<e;n+=1)t+="█▄▀"[3*Math.random()|0];return t}function distance(e,t){const n=e.length,o=t.length,r=[[],[]],i=[0,0,0];let s=0,a=0,c=0,l=1;for(a=0;a<=o;a++)r[1][a]=a;for(s=1;s<=n;s++)for(c=+!c,l=+!l,r[l][0]=s,a=1;a<=o;a++)i[0]=r[c][a]+1,i[1]=r[l][a-1]+1,i[2]=r[c][a-1]+(e[s-1]==t[a-1]?0:1),r[l][a]=Math.min(i[0],i[1],i[2]);return r[l][o]}function censor(e){const t=[];let n=0,o="",r="";return["cyr","lat"].forEach((i=>{o=e.slice().toLowerCase(),Object.entries(censorCharmap[i]).forEach((([t,r])=>{r.forEach((r=>{for(n=0;n<e.length;n+=1)o=o.replaceAll(r,t)}))})),badWords[i].forEach((i=>{for(n=0;n<=o.length-i.length;n+=1)r=o.slice(n,n+i.length),distance(r,i)<=i.length*M.censorSensitivity&&(log(`[filter] Found word "${i}" as "${r}" in string "${e}"`),t.push([n,n+i.length]))}))})),r=e.slice(),t.forEach((([e,t])=>{r=r.slice(0,e)+getRndString(t-e)+r.slice(t)})),r}function initClient(e,{host:t,port:n,type:o,protocol:r}){if(clientPool.get(e)?.alive)return;log(`[${e}] initClient`);const i=new Socket;clientPool.set(e,{client:i,host:t,port:n,type:o,protocol:r,games:{},lastTimeout:null,alive:!0,gamesRead:!1}),i.on("data",(async function(t){const n=t.toString(),o=t,r=o.readUInt16LE(0);let i,s=2;r&&(i=o.readUInt8(s),s+=1),reactions[conditions.findIndex((t=>!!t(e,n,r,i)))+1](e,o,s)})),i.on("error",(function(){log(`[${e}] error`),disconnect(e)})),i.on("timeout",(function(){log(`[${e}] timeout`),disconnect(e)})),i.on("close",(function(){log(`[${e}] connection closed, try again in ${M.reconnectTimeout/1e3/60} min`),clientPool.get(e).alive=!1,globalThis.clearTimeout(clientPool.get(e).lastTimeout),clientPool.get(e).lastTimeout=globalThis.setTimeout((()=>initClient(e,{host:t,port:n,type:o,protocol:r})),M.reconnectTimeout)})),connect(e)}function connect(e){const{port:t,host:n,protocol:o,client:r}=clientPool.get(e);r.connect(t,n,(()=>{r.write(`Vivat Sicher, Rock'n'Roll forever!!!\0${o}`)}))}function disconnect(e){send(e,134,Buffer.alloc(0)),clientPool.get(e).client.destroy()}function send(e,t,n){const o=Buffer.alloc(2);o.writeInt16LE(1+n.length),clientPool.get(e).client.write(Buffer.concat([o,Buffer.from([t]),n]))}async function handshake(e){log(`[${e}] handshake`),requestGames(e)}function requestGames(e){send(e,129,Buffer.alloc(0))}async function receiveGames(e,t,n){const o={},r=t.readUInt8(n),i=clientPool.get(e),s=i.games,a=[];let c=0;for(;n<t.length&&c<r;){let e=[],r="";const a=t.readUInt32LE(n+1);for(n+=5;0!==t[n];)e.push(t[n]),n+=1;n+=1,r=decodeArray(e),r=r.split(" "),o[a]={name:r.filter(((e,t)=>t<r.length-3)).join(" ").slice(0,-1),players:r[r.length-3],mode:M.gameModes[M.gameLetters.indexOf(r[r.length-2])],time:r[r.length-1],isNew:!!i.gamesRead&&!s[a]},c+=1}log(`[${e}] games:`,o),Object.entries(o).forEach((([e,t])=>{t.isNew&&a.push({...t,id:e})})),a.length&&sendToTgChat(M.tgChats[0],(a.length>1?`Созданы новые игры:${a.reduce(((e,t)=>"\n"+getTgGameLink(i,t)),"")}`:`Создана новая игра: ${getTgGameLink(i,a[0])}`)+"\n\nНажмите на название игры, чтобы присоединиться к ней (требуется установленная из Steam игра)"),i.games=o,i.gamesRead=!0,globalThis.clearTimeout(i.lastTimeout),i.lastTimeout=globalThis.setTimeout((()=>requestGames(e)),M.gameRequestTimeout)}function sendToTgChat(e,t){log(`[tg] sendToChat ${e}: ${t}`);const n=JSON.stringify({chat_id:e,parse_mode:"HTML",disable_web_page_preview:!0,text:t}),o=request({host:"api.telegram.org",port:M.tgPort,path:`/bot${M.tgToken}/sendMessage`,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}},receiveTgResponse);o.write(n),o.end()}function receiveTgResponse(e){let t="";e.on("data",(e=>t+=e)),e.on("end",(()=>{log(`[tg] response status code: ${e.statusCode}`),log("[tg] response body:",t)}))}function getTgGameLink(e,t){return`<a href="${M.redirectHost}:${M.redirectPort}/r?s=${e.host}&p=${e.port}&g=${t.id}">${censor(t.name.slice())}</a> (${t.mode})`}function redirectReqListener(e,t){const n=decodeURIComponent(e.url);if("/r?"===n.slice(0,3)&&~n.indexOf("s=")&&~n.indexOf("p=")&&~n.indexOf("g=")){const{s:e,p:o,g:r}=n.split("&").map((e=>e.slice(e.indexOf("=")-1).split("="))).reduce(((e,[t,n])=>({...e,[t]:n})),{});t.writeHead(302,{Location:`steam://run/264080//-server ${e} -port ${o} -game ${r}/`})}else t.writeHead(400),t.write("Invalid redirect request format");return t.end()}function printHelp(){[`Usage: node ${scriptFile} [OPTIONS]`,"","Options:","  --help, -h       Print this","  --silent, -s     Disable output"].forEach((e=>console.log(e)))}async function init(){argHelp&&(printHelp(),process.exit(0)),existsSync(configPath)||(log(`Configuration file ${configPath} was not found, aborting`),process.exit(1)),existsSync(badWordsLatinPath)||(log(`Bad words file ${badWordsLatinPath} was not found, aborting`),process.exit(1)),existsSync(badWordsCyrillicPath)||(log(`Bad words file ${badWordsCyrillicPath} was not found, aborting`),process.exit(1)),Object.assign(M,JSON.parse(readFileSync(configPath,{encoding:"utf8",flag:"r"}))),badWords.lat.push(...readFileSync(badWordsLatinPath,{encoding:"utf8",flag:"r"}).split("\n")),badWords.cyr.push(...readFileSync(badWordsCyrillicPath,{encoding:"utf8",flag:"r"}).split("\n")),webServer=createServer(redirectServerOptions,redirectReqListener),webServer.listen(M.redirectPort),M.servers.forEach((e=>initClient(`${e.host}:${e.port}`,e)))}init().then((e=>{log("All clients in the pool were initialized")}));
// @license-end