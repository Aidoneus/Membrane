// @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&dn=expat.txt Expat
"use strict";const{Socket:Socket}=require("net"),{request:request}=require("https"),{createServer:createServer}=require("http"),{existsSync:existsSync,readFileSync:readFileSync}=require("fs"),{dirname:dirname,basename:basename}=require("path"),dir=dirname(__filename),scriptFile=basename(__filename),args=process.argv.slice(2),argsI=[args.indexOf("--help"),args.indexOf("-h"),args.indexOf("--silent"),args.indexOf("-s")],argHelp=argsI[0]>=0||argsI[1]>=0,argSilent=argsI[2]>=0||argsI[3]>=0,M={},configPath=dir+"/membrane.json",badWordsLatinPath=dir+"/bad_words_latin.txt",badWordsCyrillicPath=dir+"/bad_words_cyrillic.txt",exceptionsLatinPath=dir+"/exceptions_latin.txt",exceptionsCyrillicPath=dir+"/exceptions_cyrillic.txt",cp866=`АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯабвгдежзийклмноп${" ".repeat(48)}рстуфхцчшщъыьэюяЁё${" ".repeat(14)}`,clientPool=new Map,reactions=[()=>{},handshake,receiveGames],conditions=[(e,t,n,o)=>t===`Enter, my son, please...\0${clientPool.get(e).protocol}`,(e,t,n,o)=>n&&193===o],badWords={cyr:[],lat:[]},exceptionWords={cyr:[],lat:[]},censorCharmap={lat:{a:["a","а","@"],b:["b","6"],c:["c","с","("],d:["d"],e:["e","е"],f:["f"],g:["g"],h:["h","н"],i:["i","!"],j:["j"],k:["k","к"],l:["l"],m:["m","м"],n:["n","п"],o:["o","о"],p:["p","р"],q:["q"],r:["r","г"],s:["s","$"],t:["t","+","7","т"],u:["u","и","ц"],v:["v"],w:["w"],x:["x","х"],y:["y","у"],z:["z"]},cyr:{"а":["а","a","@"],"б":["б","6","b"],"в":["в","b","v"],"г":["г","r","g"],"д":["д","d","g"],"е":["е","e"],"ё":["ё","e"],"ж":["ж","*"],"з":["з","3","z"],"и":["и","u","i"],"й":["й","u","i","y"],"к":["к","k"],"л":["л","l"],"м":["м","m"],"н":["н","h","n"],"о":["о","o","0"],"п":["п","n","p"],"р":["р","r","p"],"с":["с","c","s","("],"т":["т","m","t","+"],"у":["у","y","u"],"ф":["ф","f"],"х":["х","x","h"],"ц":["ц","c"],"ч":["ч","4"],"ш":["ш"],"щ":["щ"],"ь":["ь","b"],"ы":["ы"],"ъ":["ъ"],"э":["э","e"],"ю":["ю"],"я":["я","r"]}},tgStack=[],redirectServerOptions={};let webServer;function log(...e){if(argSilent)return;const t=new Date,n=["FullYear","Month","Date","Hours","Minutes","Seconds","Milliseconds"].map(((e,n)=>(t[`getUTC${e}`]()+(1===n?1:0)).toString(10).padStart(n&&6!==n?2:4,"0"))).reduce(((e,t,n)=>e+t+".. ::: "[n]),"");console.log(n,...e)}function encodeChar(e){if(" "===e)return 32;const t=cp866.indexOf(e);return~e?t+128:e.charCodeAt(0)}function decodeChar(e){return e<128?String.fromCharCode(e):cp866[e-128]}function encodeString(e){return Array.prototype.map.call(e,(e=>encodeChar(e)))}function decodeArray(e){return e.reduce(((e,t)=>e+decodeChar(t)),"")}function pad(e,t=2){return e.toString(10).padStart(t,"0")}function getRndString(e){let t="";for(let n=0;n<e;n+=1)t+="█▄▀"[3*Math.random()|0];return t}function distance(e,t){const n=e.length,o=t.length,i=[[],[]],r=[0,0,0];let s=0,a=0,c=0,l=1;for(a=0;a<=o;a++)i[1][a]=a;for(s=1;s<=n;s++)for(c=+!c,l=+!l,i[l][0]=s,a=1;a<=o;a++)r[0]=i[c][a]+1,r[1]=i[l][a-1]+1,r[2]=i[c][a-1]+(e[s-1]==t[a-1]?0:1),i[l][a]=Math.min(r[0],r[1],r[2]);return i[l][o]}function censor(e){const t=[],n=[];let o=0,i="",r="",s="";return["cyr","lat"].forEach((a=>{i=e.slice().toLowerCase(),exceptionWords[a].forEach((t=>{for(s=t.toLowerCase(),o=0;o<=i.length-t.length;o+=1)r=i.slice(o,o+t.length),distance(r,s)<=s.length*M.exceptionSensitivity&&(log(`[filter exception] Found word "${t}" as "${r}" in string "${e}"`),n.push([o,e.slice(o,o+t.length)]),i=i.slice(0,o)+" ".repeat(t.length)+i.slice(o+t.length))})),Object.entries(censorCharmap[a]).forEach((([t,n])=>{n.forEach((n=>{for(o=0;o<e.length;o+=1)i=i.replaceAll(n,t)}))})),badWords[a].forEach((n=>{for(s=n.toLowerCase(),o=0;o<=i.length-n.length;o+=1)r=i.slice(o,o+n.length),distance(r,s)<=s.length*M.censorSensitivity&&(log(`[filter censor] Found word "${n}" as "${r}" in string "${e}"`),t.push([o,o+n.length]))}))})),r=e.slice(),t.forEach((([e,t])=>{r=r.slice(0,e)+getRndString(t-e)+r.slice(t)})),n.forEach((([e,t])=>{r=r.slice(0,e)+t+r.slice(e+t.length)})),r}function initClient(e,{host:t,port:n,type:o,protocol:i}){if(clientPool.get(e)?.alive)return;log(`[${e}] initClient`);const r=new Socket;clientPool.set(e,{client:r,host:t,port:n,type:o,protocol:i,games:{},lastTimeout:null,alive:!0,gamesRead:!1}),r.on("data",(async function(t){const n=t.toString(),o=t,i=o.readUInt16LE(0);let r,s=2;i&&(r=o.readUInt8(s),s+=1),reactions[conditions.findIndex((t=>!!t(e,n,i,r)))+1](e,o,s)})),r.on("error",(function(){log(`[${e}] error`),disconnect(e)})),r.on("timeout",(function(){log(`[${e}] timeout`),disconnect(e)})),r.on("close",(function(){log(`[${e}] connection closed, try again in ${M.reconnectTimeout/1e3/60} min`),clientPool.get(e).alive=!1,globalThis.clearTimeout(clientPool.get(e).lastTimeout),clientPool.get(e).lastTimeout=globalThis.setTimeout((()=>initClient(e,{host:t,port:n,type:o,protocol:i})),M.reconnectTimeout)})),connect(e)}function connect(e){const{port:t,host:n,protocol:o,client:i}=clientPool.get(e);i.connect(t,n,(()=>{i.write(`Vivat Sicher, Rock'n'Roll forever!!!\0${o}`)}))}function disconnect(e){send(e,134,Buffer.alloc(0)),clientPool.get(e).client.destroy()}function send(e,t,n){const o=Buffer.alloc(2);o.writeInt16LE(1+n.length),clientPool.get(e).client.write(Buffer.concat([o,Buffer.from([t]),n]))}async function handshake(e){log(`[${e}] handshake`),requestGames(e)}function requestGames(e){send(e,129,Buffer.alloc(0))}async function receiveGames(e,t,n){const o={},i=t.readUInt8(n),r=clientPool.get(e),s=r.games,a=[];let c=0;for(;n<t.length&&c<i;){let e=[],i="";const a=t.readUInt32LE(n+1);for(n+=5;0!==t[n];)e.push(t[n]),n+=1;i=decodeArray(e),i=i.split(" "),o[a]={name:i.filter(((e,t)=>t<i.length-3)).join(" ").slice(0,-1),players:i[i.length-3],mode:M.gameModes[M.gameLetters.indexOf(i[i.length-2])],time:i[i.length-1],isNew:!!r.gamesRead&&!s[a]},c+=1}log(`[${e}] games:`,o),Object.entries(o).forEach((([e,t])=>{t.isNew&&a.push({...t,id:e})})),a.length&&sendToTgChat(M.tgChats[0],(a.length>1?`Созданы новые игры:${a.reduce(((e,t)=>e+"\n"+getTgGameLink(r,t)),"")}`:`Создана новая игра: ${getTgGameLink(r,a[0])}`)+"\n\nНажмите по названию игры, чтобы присоединиться к ней (требуется установленная из Steam игра)"),r.games=o,r.gamesRead=!0,globalThis.clearTimeout(r.lastTimeout),r.lastTimeout=globalThis.setTimeout((()=>requestGames(e)),a.length?M.gameRequestCooldown:M.gameRequestTimeout)}function sendToTgChat(e,t){log(`[tg] sendToChat ${e}: ${t}`);const n=JSON.stringify({chat_id:e,parse_mode:"HTML",disable_web_page_preview:!0,text:t}),o=request({host:"api.telegram.org",port:M.tgPort,path:`/bot${M.tgToken}/sendMessage`,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}},receiveTgResponse);o.write(n),o.end()}function receiveTgResponse(e){let t="";e.on("data",(e=>t+=e)),e.on("end",(()=>{log(`[tg] response status code: ${e.statusCode}`),log("[tg] response body:",t)}))}function getTgGameLink(e,t){return`<a href="${M.redirectHost}:${M.redirectPort}/r?s=${e.host}&p=${e.port}&g=${t.id}">${censor(t.name.slice())}</a> (${t.mode})`}function redirectReqListener(e,t){const n=decodeURIComponent(e.url);if("/r?"===n.slice(0,3)&&~n.indexOf("s=")&&~n.indexOf("p=")&&~n.indexOf("g=")){const{s:e,p:o,g:i}=n.split("&").map((e=>e.slice(e.indexOf("=")-1).split("="))).reduce(((e,[t,n])=>({...e,[t]:n})),{});t.writeHead(302,{Location:`steam://run/264080//-server ${e} -port ${o} -game ${i}/`})}else t.writeHead(400),t.write("Invalid redirect request format");return t.end()}function printHelp(){[`Usage: node ${scriptFile} [OPTIONS]`,"","Options:","  --help, -h       Print this","  --silent, -s     Disable output"].forEach((e=>console.log(e)))}async function init(){argHelp&&(printHelp(),process.exit(0)),[[existsSync(configPath),`Configuration file ${configPath} was not found, aborting`],[existsSync(badWordsLatinPath),`Bad words file ${badWordsLatinPath} was not found, aborting`],[existsSync(badWordsCyrillicPath),`Bad words file ${badWordsCyrillicPath} was not found, aborting`],[existsSync(exceptionsLatinPath),`Exception words file ${exceptionsLatinPath} was not found, aborting`],[existsSync(exceptionsCyrillicPath),`Exception words file ${exceptionsCyrillicPath} was not found, aborting`]].forEach(((e,t)=>{e||(log(t),process.exit(1))})),Object.assign(M,JSON.parse(readFileSync(configPath,{encoding:"utf8",flag:"r"}))),badWords.lat.push(...readFileSync(badWordsLatinPath,{encoding:"utf8",flag:"r"}).split("\n")),badWords.cyr.push(...readFileSync(badWordsCyrillicPath,{encoding:"utf8",flag:"r"}).split("\n")),exceptionWords.lat.push(...readFileSync(exceptionsLatinPath,{encoding:"utf8",flag:"r"}).split("\n")),exceptionWords.cyr.push(...readFileSync(exceptionsCyrillicPath,{encoding:"utf8",flag:"r"}).split("\n")),webServer=createServer(redirectServerOptions,redirectReqListener),webServer.listen(M.redirectPort),M.servers.forEach((e=>initClient(`${e.host}:${e.port}`,e)))}init().then((e=>{log("All clients in the pool were initialized")}));
// @license-end