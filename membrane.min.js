// @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&dn=expat.txt Expat
"use strict";const{Socket:Socket}=require("net"),{request:request}=require("https"),{createServer:createServer}=require("http"),{existsSync:existsSync,readFileSync:readFileSync}=require("fs"),{dirname:dirname,basename:basename}=require("path"),dir=dirname(__filename),scriptFile=basename(__filename),args=process.argv.slice(2),argsI=[args.indexOf("--help"),args.indexOf("-h"),args.indexOf("--silent"),args.indexOf("-s")],argHelp=argsI[0]>=0||argsI[1]>=0,argSilent=argsI[2]>=0||argsI[3]>=0,M={},configPath=dir+"/membrane.json",badWordsLatinPath=dir+"/bad_words_latin.txt",badWordsCyrillicPath=dir+"/bad_words_cyrillic.txt",cp866=`АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯабвгдежзийклмноп${" ".repeat(48)}рстуфхцчшщъыьэюяЁё${" ".repeat(14)}`,clientPool=new Map,reactions=[()=>{},handshake,receiveGames],conditions=[(e,t,n,r)=>t===`Enter, my son, please...\0${clientPool.get(e).protocol}`,(e,t,n,r)=>n&&193===r],badWords={cyr:[],lat:[]},censorCharmap={lat:{a:["a","а","@"],b:["b","6"],c:["c","с","("],d:["d"],e:["e","е"],f:["f"],g:["g"],h:["h","н"],i:["i","!"],j:["j"],k:["k","к"],l:["l"],m:["m","м"],n:["n","п"],o:["o","о"],p:["p","р"],q:["q"],r:["r","г"],s:["s","$"],t:["t","+","7","т"],u:["u","и","ц"],v:["v"],w:["w"],x:["x","х"],y:["y","у"],z:["z"]},cyr:{"а":["а","a","@"],"б":["б","6","b"],"в":["в","b","v"],"г":["г","r","g"],"д":["д","d","g"],"е":["е","e"],"ё":["ё","e"],"ж":["ж","*"],"з":["з","3","z"],"и":["и","u","i"],"й":["й","u","i","y"],"к":["к","k"],"л":["л","l"],"м":["м","m"],"н":["н","h","n"],"о":["о","o","0"],"п":["п","n","p"],"р":["р","r","p"],"с":["с","c","s","("],"т":["т","m","t","+"],"у":["у","y","u"],"ф":["ф","f"],"х":["х","x","h"],"ц":["ц","c"],"ч":["ч","4"],"ш":["ш"],"щ":["щ"],"ь":["ь","b"],"ы":["ы"],"ъ":["ъ"],"э":["э","e"],"ю":["ю"],"я":["я","r"]}},tgStack=[],redirectServerOptions={};let webServer;function log(...e){!argSilent&&console.log(...e)}function encodeChar(e){if(" "===e)return 32;const t=cp866.indexOf(e);return~e?t+128:e.charCodeAt(0)}function decodeChar(e){return e<128?String.fromCharCode(e):cp866[e-128]}function encodeString(e){return Array.prototype.map.call(e,(e=>encodeChar(e)))}function decodeArray(e){return e.reduce(((e,t)=>e+decodeChar(t)),"")}function pad(e,t=2){return e.toString(10).padStart(t,"0")}function getRndString(e){let t="";for(let n=0;n<e;n+=1)t+="█▄▀"[3*Math.random()|0];return t}function distanceMin(e,t,n,r,o){return e<t||n<t?e>n?n+1:e+1:r===o?t:t+1}function distance(e,t){if(e===t)return 0;e.length>t.length&&([e,t]=[t,e]);let n,r,o,i,a,s,c,l,d,g,u,f,h=e.length,p=t.length,m=0,b=[],y=0;for(;h>0&&e[h-1]===t[p-1];)h--,p--;for(;m<h&&e[m]===t[m];)m++;if(h-=m,p-=m,0===h||p<3)return p;for(n=0;n<h;n++)b.push(n+1),b.push(e.charCodeAt(m+n));const S=b.length-1;for(;y<p-3;)for(d=t.charCodeAt(m+(r=y)),g=t.charCodeAt(m+(o=y+1)),u=t.charCodeAt(m+(i=y+2)),f=t.charCodeAt(m+(a=y+3)),s=y+=4,n=0;n<S;n+=2)c=b[n],l=b[n+1],r=distanceMin(c,r,o,d,l),o=distanceMin(r,o,i,g,l),i=distanceMin(o,i,a,u,l),s=distanceMin(i,a,s,f,l),b[n]=s,a=i,i=o,o=r,r=c;for(;y<p;)for(d=t.charCodeAt(m+(r=y)),s=++y,n=0;n<S;n+=2)c=b[n],b[n]=s=distanceMin(c,r,s,d,b[n+1]),r=c;return s}function censor(e){const t=[];let n=0,r="",o="";return["cyr","lat"].forEach((i=>{r=e.slice().toLowerCase(),Object.entries(censorCharmap[i]).forEach((([t,o])=>{o.forEach((o=>{for(n=0;n<e.length;n+=1)r=r.replaceAll(o,t)}))})),badWords[i].forEach((i=>{for(n=0;n<=r.length-i.length;n+=1)o=r.slice(n,n+i.length),distance(o,i)<=.25*i.length&&(log(`[filter] Found word "${i}" as "${o}" in string "${e}"`),t.push([n,n+i.length]))}))})),o=e.slice(),t.forEach((([e,t])=>{o=o.slice(0,e)+getRndString(t-e)+o.slice(t)})),o}function initClient(e,{host:t,port:n,type:r,protocol:o}){if(clientPool.get(e)?.alive)return;log(`[${e}] initClient`);const i=new Socket;clientPool.set(e,{client:i,host:t,port:n,type:r,protocol:o,games:{},lastTimeout:null,alive:!0,gamesRead:!1}),i.on("data",(async function(t){const n=t.toString(),r=t,o=r.readUInt16LE(0);let i,a=2;o&&(i=r.readUInt8(a),a+=1),reactions[conditions.findIndex((t=>!!t(e,n,o,i)))+1](e,r,a)})),i.on("error",(function(){log(`[${e}] error`),disconnect(e)})),i.on("timeout",(function(){log(`[${e}] timeout`),disconnect(e)})),i.on("close",(function(){log(`[${e}] connection closed, try again in ${M.reconnectTimeout/1e3/60} min`),clientPool.get(e).alive=!1,globalThis.clearTimeout(clientPool.get(e).lastTimeout),clientPool.get(e).lastTimeout=globalThis.setTimeout((()=>initClient(e,{host:t,port:n,type:r,protocol:o})),M.reconnectTimeout)})),connect(e)}function connect(e){const{port:t,host:n,protocol:r,client:o}=clientPool.get(e);o.connect(t,n,(()=>{o.write(`Vivat Sicher, Rock'n'Roll forever!!!\0${r}`)}))}function disconnect(e){send(e,134,Buffer.alloc(0)),clientPool.get(e).client.destroy()}function send(e,t,n){const r=Buffer.alloc(2);r.writeInt16LE(1+n.length),clientPool.get(e).client.write(Buffer.concat([r,Buffer.from([t]),n]))}async function handshake(e){log(`[${e}] handshake`),requestGames(e)}function requestGames(e){send(e,129,Buffer.alloc(0))}async function receiveGames(e,t,n){const r={},o=t.readUInt8(n),i=clientPool.get(e),a=i.games,s=[];let c=0;for(;n<t.length&&c<o;){let e=[],o="";const s=t.readUInt32LE(n+1);for(n+=5;0!==t[n];)e.push(t[n]),n+=1;n+=1,o=decodeArray(e),o=o.split(" "),r[s]={name:o.filter(((e,t)=>t<o.length-3)).join(" ").slice(0,-1),players:o[o.length-3],mode:M.gameModes[M.gameLetters.indexOf(o[o.length-2])],time:o[o.length-1],isNew:!!i.gamesRead&&!a[s]},c+=1}log(`[${e}] games:`,r),Object.entries(r).forEach((([e,t])=>{t.isNew&&s.push({...t,id:e})})),s.length&&sendToTgChat(M.tgChats[0],(s.length>1?`Созданы новые игры:${s.reduce(((e,t)=>"\n"+getTgGameLink(i,t)),"")}`:`Создана новая игра: ${getTgGameLink(i,s[0])}`)+"\n\nНажмите на название игры, чтобы присоединиться к ней (требуется установленная из Steam игра)"),i.games=r,i.gamesRead=!0,globalThis.clearTimeout(i.lastTimeout),i.lastTimeout=globalThis.setTimeout((()=>requestGames(e)),M.gameRequestTimeout)}function sendToTgChat(e,t){log(`[tg] sendToChat ${e}: ${t}`);const n=JSON.stringify({chat_id:e,parse_mode:"HTML",disable_web_page_preview:!0,text:t}),r=request({host:"api.telegram.org",port:M.tgPort,path:`/bot${M.tgToken}/sendMessage`,method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}},receiveTgResponse);r.write(n),r.end()}function receiveTgResponse(e){let t="";e.on("data",(e=>t+=e)),e.on("end",(()=>{log(`[tg] response status code: ${e.statusCode}`),log("[tg] response body:",t)}))}function getTgGameLink(e,t){return`<a href="${M.redirectHost}:${M.redirectPort}/r?s=${e.host}&p=${e.port}&g=${t.id}">${censor(t.name.slice())}</a> (${t.mode})`}function redirectReqListener(e,t){const n=decodeURIComponent(e.url);if("/r?"===n.slice(0,3)&&~n.indexOf("s=")&&~n.indexOf("p=")&&~n.indexOf("g=")){const{s:e,p:r,g:o}=n.split("&").map((e=>e.slice(e.indexOf("=")-1).split("="))).reduce(((e,[t,n])=>({...e,[t]:n})),{});t.writeHead(302,{Location:`steam://run/264080//-server ${e} -port ${r} -game ${o}/`})}else t.writeHead(400),t.write("Invalid redirect request format");return t.end()}function printHelp(){[`Usage: node ${scriptFile} [OPTIONS]`,"","Options:","  --help, -h       Print this","  --silent, -s     Disable output"].forEach((e=>console.log(e)))}async function init(){argHelp&&(printHelp(),process.exit(0)),existsSync(configPath)||(log(`Configuration file ${configPath} was not found, aborting`),process.exit(1)),existsSync(badWordsLatinPath)||(log(`Bad words file ${badWordsLatinPath} was not found, aborting`),process.exit(1)),existsSync(badWordsCyrillicPath)||(log(`Bad words file ${badWordsCyrillicPath} was not found, aborting`),process.exit(1)),Object.assign(M,JSON.parse(readFileSync(configPath,{encoding:"utf8",flag:"r"}))),badWords.lat.push(...readFileSync(badWordsLatinPath,{encoding:"utf8",flag:"r"}).split("\n")),badWords.cyr.push(...readFileSync(badWordsCyrillicPath,{encoding:"utf8",flag:"r"}).split("\n")),webServer=createServer(redirectServerOptions,redirectReqListener),webServer.listen(M.redirectPort),M.servers.forEach((e=>initClient(`${e.host}:${e.port}`,e)))}init().then((e=>{log("All clients in the pool were initialized")}));
// @license-end